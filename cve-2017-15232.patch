From f32fe0418ccdf7d7ab1805d490c13457a1e7b79a Mon Sep 17 00:00:00 2001
From: Victor Rodriguez <victor.rodriguez.bahena@intel.com>
Date: Sat, 28 Oct 2017 22:28:07 +0000
Subject: [PATCH] Handle NULL buffer when discarding rows

This commit is a merge of:

https://github.com/libjpeg-turbo/libjpeg-turbo/pull/182/commits

    Handle NULL buffer when discarding rows
    Add missing message

Report in :

mozilla/mozjpeg#268

Signed-off-by: Kornel pornel <github@pornel.net>
---
 jdpostct.c | 6 ++++++
 jerror.h   | 1 +
 jquant1.c  | 3 +++
 3 files changed, 10 insertions(+)

diff --git a/jdpostct.c b/jdpostct.c
index 601fc2a..427e980 100644
--- a/jdpostct.c
+++ b/jdpostct.c
@@ -132,6 +132,12 @@ post_process_1pass (j_decompress_ptr cinfo,
   my_post_ptr post = (my_post_ptr) cinfo->post;
   JDIMENSION num_rows, max_rows;
 
+  /* read_and_discard_scanlines may call it with rows "available", but no buffer */
+  if (output_buf == NULL) {
+      return;
+  }
+
+
   /* Fill the buffer, but not more than what we can dump out in one go. */
   /* Note we rely on the upsampler to detect bottom of image. */
   max_rows = out_rows_avail - *out_row_ctr;
diff --git a/jerror.h b/jerror.h
index 11a07cb..05de238 100644
--- a/jerror.h
+++ b/jerror.h
@@ -208,6 +208,7 @@ JMESSAGE(JERR_NO_ARITH_TABLE, "Arithmetic table 0x%02x was not defined")
 JMESSAGE(JWRN_ARITH_BAD_CODE, "Corrupt JPEG data: bad arithmetic code")
 #endif
 #endif
+JMESSAGE(JERR_BAD_PARAM, "Bogus parameter")
 
 #ifdef JMAKE_ENUM_LIST
 
diff --git a/jquant1.c b/jquant1.c
index e781481..eb36f3d 100644
--- a/jquant1.c
+++ b/jquant1.c
@@ -530,6 +530,9 @@ quantize_ord_dither (j_decompress_ptr cinfo, JSAMPARRAY input_buf,
   int row;
   JDIMENSION col;
   JDIMENSION width = cinfo->output_width;
+  if (output_buf == NULL && num_rows) {
+      ERREXIT(cinfo, JERR_BAD_PARAM);
+  }
 
   for (row = 0; row < num_rows; row++) {
     /* Initialize output values to 0 so can process components separately */
-- 
2.14.2

